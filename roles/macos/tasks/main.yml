---
- import_tasks: brew.yml
  become: no

- name: Configure screenshots dir
  file:
    path: "/Users/{{ ansible_env.SUDO_USER }}/Screenshots"
    state: directory
- shell: >
    defaults write com.apple.screencapture location ~/Screenshots
  become: no

- name: Unlink gnu-ls without color
  file:
    path: '/usr/local/opt/coreutils/libexec/gnubin/ls'
    state: absent

- name: Install python libs
  pip:
    name: "{{ item }}"
  with_items:
    - virtualenv
    - docker-compose
    - ipython


- name: Install grml basic configs
  get_url:
    url: "https://grml.org/console/{{ item }}"
    dest: "/Users/{{ ansible_env.SUDO_USER }}/.{{ item }}"
  become: no
  with_items:
    - zshrc
    - vimrc

- name: Add zsh to official shell
  lineinfile:
    path: "/etc/shells"
    line: "/usr/local/bin/zsh"

- name: Change users shell
  user:
    name: "{{ ansible_env.SUDO_USER }}"
    shell: "/usr/local/bin/zsh"


- name: Synchronize configs
  synchronize:
    src: Users/
    dest: "/Users/{{ ansible_env.SUDO_USER }}/"
    archive: yes
  become: no


- name: Create dirs for pathogen
  file:
    path: "/Users/{{ ansible_env.SUDO_USER }}/.vim/{{ item }}"
    state: directory
  become: no
  with_items:
    - autoload
    - bundle

- name: Setup vim pathogen
  get_url:
    url: "https://tpo.pe/pathogen.vim"
    dest: "/Users/{{ ansible_env.SUDO_USER }}/.vim/autoload/pathogen.vim"
  become: no

- name: Setup Vundle
  git:
    repo: "https://github.com/VundleVim/Vundle.vim.git"
    dest: "/Users/{{ ansible_env.SUDO_USER }}/.vim/bundle/Vundle.vim"
  become: no

- name: Init vim plugins
  shell: "vim +PlugInstall +qall"
  become: no


- name: Create dir for autocompletion
  file:
    path: "/Users/{{ ansible_env.SUDO_USER }}/.zsh/completion"
    state: directory
  become: no

- name: Setup zsh completion
  get_url:
    url: "{{ item.url }}"
    dest: "{{ item.dest }}"
  become: no
  with_items:
    - url: "https://raw.githubusercontent.com/docker/cli/master/contrib/completion/zsh/_docker"
      dest: "/Users/{{ ansible_env.SUDO_USER }}/.zsh/_docker"
    - url: "https://raw.githubusercontent.com/docker/compose/1.23.1/contrib/completion/zsh/_docker-compose"
      dest: "/Users/{{ ansible_env.SUDO_USER }}/.zsh/_docker-compose"


- name: Setup mpd
  file:
    path: "/Users/{{ ansible_env.SUDO_USER }}/.mpd/{{ item }}"
    state: touch
  with_items:
    - "playlists"
    - "mpd.db"


- name: Configure ssh client
  lineinfile:
    dest: "/Users/{{ ansible_env.SUDO_USER }}/.ssh/config"
    line: "{{ item }}"
    owner: "{{ ansible_env.SUDO_USER }}"
    group: "staff"
    create: yes
  with_items:
    - Host *
    - ForwardAgent yes
    - StrictHostKeyChecking no
    - ControlMaster auto
    - ControlPath /tmp/%r@%h:%p
    - ControlPersist 10m
    - Include ~/.ssh/config.d/*
  become: no

- name: Set right file owner
  file:
    path: "/Users/{{ ansible_env.SUDO_USER }}"
    state: directory
    owner: "{{ ansible_env.SUDO_USER }}"
    group: "staff"
